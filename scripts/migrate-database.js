const mysql = require('mysql2/promise')

const connectionConfig = {
  host: '127.0.0.1',
  port: 3306,
  user: 'root',
  password: '',
  database: 'burza_web',
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0,
}

async function migrateDatabase() {
  const connection = await mysql.createConnection(connectionConfig)
  
  try {
    console.log('üîÑ Spou≈°t√≠m migraci datab√°ze...')
    
    // Kontrola existence sloupc≈Ø
    const [columns] = await connection.execute(`
      SELECT COLUMN_NAME 
      FROM INFORMATION_SCHEMA.COLUMNS 
      WHERE TABLE_SCHEMA = 'burza_web' 
      AND TABLE_NAME = 'users'
    `)
    
    const existingColumns = columns.map(col => col.COLUMN_NAME)
    console.log('üìã Existuj√≠c√≠ sloupce:', existingColumns)
    
    // P≈ôid√°n√≠ chybƒõj√≠c√≠ch sloupc≈Ø
    const columnsToAdd = [
      {
        name: 'nickname',
        definition: 'VARCHAR(191) NULL',
        description: 'P≈ôezd√≠vka u≈æivatele'
      },
      {
        name: 'city',
        definition: 'VARCHAR(191) NULL',
        description: 'Mƒõsto u≈æivatele'
      },
      {
        name: 'bio',
        definition: 'TEXT NULL',
        description: 'Bio u≈æivatele'
      },
      {
        name: 'reputation',
        definition: "ENUM('VERY_GOOD', 'GOOD', 'NEUTRAL', 'BAD', 'VERY_BAD') NOT NULL DEFAULT 'NEUTRAL'",
        description: 'Reputace u≈æivatele'
      }
    ]
    
    for (const column of columnsToAdd) {
      if (!existingColumns.includes(column.name)) {
        console.log(`‚ûï P≈ôid√°v√°m sloupec: ${column.name}`)
        await connection.execute(`
          ALTER TABLE users 
          ADD COLUMN ${column.name} ${column.definition}
        `)
        console.log(`‚úÖ Sloupec ${column.name} byl √∫spƒõ≈°nƒõ p≈ôid√°n`)
      } else {
        console.log(`‚è≠Ô∏è  Sloupec ${column.name} ji≈æ existuje`)
      }
    }
    
    console.log('üéâ Migrace datab√°ze dokonƒçena!')
    
  } catch (error) {
    console.error('‚ùå Chyba p≈ôi migraci datab√°ze:', error)
    throw error
  } finally {
    await connection.end()
  }
}

// Spu≈°tƒõn√≠ migrace
migrateDatabase()
  .then(() => {
    console.log('‚úÖ Migrace byla √∫spƒõ≈°nƒõ dokonƒçena')
    process.exit(0)
  })
  .catch((error) => {
    console.error('‚ùå Migrace selhala:', error)
    process.exit(1)
  })
